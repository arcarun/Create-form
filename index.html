<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Task Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 8px;
            background-color: #0A3A2A;
            color: #e0e0e0;
            font-size: 0.95rem;
        }
        .container {
            max-width: 400px;
            margin: auto;
            background-color: #1e2632;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            width: 90%;
            box-sizing: border-box;
        }
        h1 {
            color: #FFFF00;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #cccccc;
            font-size: 0.9rem;
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: calc(100% - 14px);
            padding: 8px;
            margin-bottom: 12px;
            border: 1px solid #4a5a70;
            border-radius: 6px;
            background-color: #3e4d65;
            color: #e0e0e0;
            box-sizing: border-box;
            font-size: 0.9rem;
            font-family: Arial, sans-serif;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            border-color: #6fb9f0;
            outline: none;
            box-shadow: 0 0 0 2px rgba(111, 185, 240, 0.3);
        }
        textarea {
            resize: vertical;
            min-height: 50px;
            rows: 3;
        }
        button {
            background-color: #6fb9f0;
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: background-color 0.3s ease;
            margin-top: 8px;
            font-family: Arial, sans-serif;
        }
        button:hover {
            background-color: #559dd6;
        }
        #snDisplay {
            text-align: center;
            font-size: 0.8rem;
            font-weight: normal;
            margin-bottom: 12px;
            color: #a0d468;
            font-family: Arial, sans-serif;
        }
        /* Styles for Autocomplete List */
        .autocomplete-suggestions {
            border: 1px solid #4a5a70;
            background-color: #3e4d65;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            z-index: 99;
            width: calc(100% - 30px);
            border-radius: 0 0 6px 6px;
        }
        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
            color: #e0e0e0;
            font-size: 0.9rem;
            font-family: Arial, sans-serif;
        }
        .autocomplete-suggestion:hover {
            background-color: #6fb9f0;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>New Task</h1>
        <div id="snDisplay">SN: Loading...</div>
        <form id="taskForm">
            <label for="company">Company:</label>
            <input type="text" id="company" name="company" required list="companySuggestions">
            <datalist id="companySuggestions"></datalist>

            <label for="user">User:</label>
            <input type="text" id="user" name="user" required list="userSuggestions">
            <datalist id="userSuggestions"></datalist>

            <label for="mob">Mobile:</label>
            <input type="text" id="mob" name="mob" required pattern="[0-9]{10,15}" title="Please enter a valid mobile number">

            <label for="location">Location:</label>
            <input type="text" id="location" name="location" required>

            <label for="bill">Bill:</label>
            <input type="text" id="bill" name="bill">

            <label for="type">Type:</label>
            <select id="type" name="type" required>
                <option value="Call Basic">Call Basic</option>
                <option value="AMC">AMC</option>
                <option value="Rentals">Rentals</option>
                <option value="Vendor">Vendor</option>
            </select>

            <label for="task">Task Detail:</label>
            <textarea id="task" name="task" rows="3" required></textarea>
            <button type="submit">Submit</button>
        </form>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        const form = document.getElementById('taskForm');
        const snDisplay = document.getElementById('snDisplay');
        const companyInput = document.getElementById('company');
        const userInput = document.getElementById('user');
        const companySuggestions = document.getElementById('companySuggestions');
        const userSuggestions = document.getElementById('userSuggestions');
        
        // Function to load unique items from local storage
        function loadSuggestions(key) {
            const data = localStorage.getItem(key);
            return data ? Array.from(new Set(JSON.parse(data))) : [];
        }

        // Function to save a new item to local storage
        function saveSuggestion(key, item) {
            if (!item || item.trim() === '') return;
            let suggestions = loadSuggestions(key);
            if (!suggestions.includes(item.trim())) {
                suggestions.push(item.trim());
                localStorage.setItem(key, JSON.stringify(suggestions));
            }
        }

        // Function to update datalist options
        function updateDatalist(inputElement, datalistElement, key) {
            const suggestions = loadSuggestions(key);
            datalistElement.innerHTML = ''; // Clear previous options
            suggestions.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                datalistElement.appendChild(option);
            });
        }

        function sendDataToBot(data) {
            try {
                if (window.Telegram && window.Telegram.WebApp) {
                    saveSuggestion('companies', data.company);
                    saveSuggestion('users', data.user);
                    
                    window.Telegram.WebApp.sendData(JSON.stringify(data));
                    window.Telegram.WebApp.close();
                } else {
                    alert('Telegram WebApp is not available. Cannot send data.');
                    console.error('Telegram WebApp object not found.');
                }
            } catch (error) {
                alert('An error occurred while sending data. Check the console for details.');
                console.error("Error in sendDataToBot:", error);
            }
        }

        form.addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = {
                company: companyInput.value,
                user: userInput.value,
                mob: document.getElementById('mob').value,
                location: document.getElementById('location').value,
                bill: document.getElementById('bill').value,
                type: document.getElementById('type').value,
                task: document.getElementById('task').value,
            };

            sendDataToBot(formData);
        });

        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.setHeaderColor('#1e2632');
            window.Telegram.WebApp.setBackgroundColor('#0A3A2A');

            let currentSN = localStorage.getItem('sn_counter');
            if (currentSN === null || isNaN(parseInt(currentSN))) {
                currentSN = 0;
                localStorage.setItem('sn_counter', currentSN);
            }
            const nextSN = parseInt(currentSN) + 1;
            snDisplay.textContent = `SN: ${String(nextSN).padStart(2, '0')}`;

            // Load and update suggestions on app start
            updateDatalist(companyInput, companySuggestions, 'companies');
            updateDatalist(userInput, userSuggestions, 'users');
        } else {
            snDisplay.textContent = "SN: (Telegram Web App not found)";
            console.error('Telegram WebApp object not available.');
        }
    </script>
</body>
</html>
